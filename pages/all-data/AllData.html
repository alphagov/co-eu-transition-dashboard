{% extends "template.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% set cellBlock = "cell-color-"  %}
{% set flag = '' %}
{% set filtersExist = 'false' %}

{% set fromDate = "01/01/" + currentDate | date("YYYY") %}
{% set toDate = "01/01/" + currentDate | date("add", 1, "year") | date("YYYY") %}

{% set dates  %}
{% include "all-data/partials/filters/dates.njk" %}
{% endset %}

{% set dateList  %}
{% include "all-data/partials/filters/date-list.njk" %}
{% endset %}

{% set contentHtml %}
{% include "all-data/partials/data-table/content.njk" %}
{% endset -%}

{% set count = 0 %}
{% set items = [] %}
{% set sections = [] %}
{% set summary = [] %}
{% set filterNames = [] %}
{% set projectKey = [] %}
{% set projectValue = [] %}
{% set projectFields = [] %}
{% set milestoneKey = [] %}
{% set milestoneValue = [] %}
{% set milestoneFields = [] %}
{% set filterNames = [] %}
{% set filterTitles = [] %}
{% set filters = filters() | await %}
{% set projects = projects() | await %}

 {{ items.push ({
    heading: {
      text: "Milestone Due Dates"
    },
    content: {
      html: dates
    }
  })
}}

 {{ summary.push ({
    key: {
      html: "<span class='date-name'>Showing milestone due dates </span>"
    },
    value: {
      html: dateList
    }
  })
}}

{% block pageTitle %}{{ index }}{% endblock %}

{% block content %}

<h1 class="govuk-heading-xl">{{ index }}</h1>

<div class="govuk-grid-row" id="show">

<div class="govuk-grid-column-one-quarter" id="filterPanel">

  {% for tableFieldId in filtersFields %}

    {% set filter = getField(filters, tableFieldId) %}

    {% set filterCheckboxes  %}
      {% if (filter.options | length != 1) %}
        {% set filterTitles = (filterTitles.push (filter.name), filterTitles) %}
        {% for option in filter.options %}
          {% if option.value !== null %}
            {% include "all-data/partials/filters/checkboxes.njk" %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endset -%}

    {% if filter.name in filterTitles %}
       {% set items = (items.push ({
          heading: {
            text: filter.name
          },
          content: {
            html: filterCheckboxes
          }
        }), items)
      %}
    {% endif %}

  {% endfor %}

  <form action="{{ url }}" method="post">
    <h3 class="govuk-heading-s panelTitle">Filters</h3>
    {% include "all-data/partials/filters/all-filters.njk" %}
    {% include "all-data/partials/filters/filter-btn.njk" %}

  </form>

</div>

<div class="govuk-grid-column-full" id="dataTable">

  <div id="showFilter">
  {% include "all-data/partials/filters/show-filter-btn.njk" %}
  </div>

  <div id="hideFilter">
  {% include "all-data/partials/filters/hide-filter-btn.njk" %}
  </div>

  {% set projectKey = [{ text:'Project Name' }, { text:'Department' }, { text:'Impact' }, { text:'HMG Confidence' }, { text:'Citizen Readiness' }, { text:'Business Readiness' }, { text:'EU State Confidence' }] %}

{% set tableHeaderHtml %}
    {% include "all-data/partials/data-table/table-header.njk" %}
{% endset -%}

{% set sections = (sections.push ({
    heading: {
      html: tableHeaderHtml
    }
  }), sections) %}

  {% for project in projects %}

  {% for tableFieldId in tableFields %}

    {% set field = getField(project.fields, tableFieldId) %}
    {% set projectValue = (projectValue.push({html: "<span class=" + cellBlock + field.value + ">" + field.value | default('N/A')  + "</span>" }), projectValue) %}

  {% endfor %}

    {% set projectFields = (projectFields.push(projectValue), projectFields) %}

  {% for milestone in project.milestones %}
    {% set milestoneValue = [] %}
    {% set milestoneKey = [] %}
    {% for field in milestone.fields %}

      {% set milestoneKey = (milestoneKey.push({text: field.name }), milestoneKey) %}

    {% if (field.name == 'Due Date') and (field.value < currentDate) %}
      {% set flag = 'red-date' %}
    {% endif %}

      {% set milestoneValue = (milestoneValue.push({html: "<span class=" + flag + ">" + field.value | date("D MMM YYYY") + "</span>"  if field.type == 'date' else
      "<span>" + field.value | default('N/A') + "</span>" }), milestoneValue) %}

    {% endfor %}

    {% set milestoneFields = (milestoneFields.push(milestoneValue), milestoneFields) %}

    {% set contentHtml  %}
      {% include "all-data/partials/data-table/content.njk" %}
    {% endset  %}

  {% endfor %}

  {% set dataRowsHtml  %}
    {% include "all-data/partials/data-table/data-rows.njk" %}
  {% endset  %}

      {% set sections = (sections.push ({
          summary: {
            html: dataRowsHtml
          },
          content: {
            html: contentHtml
          }
        }), sections)
      %}

    {% set projectFields = [] %}
    {% set milestoneFields = [] %}
    {% set projectValue = [] %}

    {% set count = loop.index %}

  {% endfor %}

  <div>
  <h3 class="govuk-heading-s">Selected filters</h3>

  {% for filter in filters %}
    {% set filterSummary  %}
      {% for option in filter.options %}
        {% if option.value in data.filters[filter.id] | default([]) %}
          {% include "all-data/partials/filters/filter-list.njk" %}
        {% endif %}
      {% endfor %}
    {% endset -%}

      {% if filter.name in filterNames %}
            {% set summary = (summary.push ({
            key: {
              html: "<span class='filter-name'>" + filter.name + "</span>"
            },
            value: {
              html: filterSummary
            }
          }), summary)
        %}
      {% endif %}
    {% endfor %}

    {% include "all-data/partials/filters/filter-summary.njk" %}

  </div>

  <h2 class="govuk-heading-m">{{ count }} Projects displayed</h2>
  <hr>

  <a class="govuk-link" href="{{ config.paths.impactDefinitions }}">View impact and confidence definitions</a>
  <br><br><br><br><br><br>

  {% include "all-data/partials/data-table/table.njk" %}

  </div>

</div>

{% endblock %}




